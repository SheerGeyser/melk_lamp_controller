<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MELK Lamp Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bluetooth': '#0082FC',
                        'bluetooth-gray': '#9CA3AF'
                    }
                }
            }
        }
    </script>
    <style>
        /* iOS Toggle Switch */
        .ios-toggle {
            position: relative;
            width: 60px;
            height: 34px;
            background-color: #ccc;
            border-radius: 34px;
            transition: background-color 0.3s;
            cursor: pointer;
            border: none;
            outline: none;
        }

        .ios-toggle.active {
            background-color: #4CAF50;
        }

        .ios-toggle::before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background-color: white;
            top: 4px;
            left: 4px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .ios-toggle.active::before {
            transform: translateX(26px);
        }

        /* Bluetooth Icon */
        .bluetooth-icon {
            width: 24px;
            height: 24px;
            transition: all 0.3s ease;
        }

        .bluetooth-icon.connected {
            color: #0082FC;
        }

        .bluetooth-icon.disconnected {
            color: #9CA3AF;
        }

        /* Custom Color Picker */
        .color-picker {
            width: 100%;
            height: 50px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background: none;
        }

        /* Custom Slider */
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Preset Colors */
        .preset-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .preset-color:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
    <!-- Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -left-40 w-80 h-80 bg-blue-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse"></div>
        <div class="absolute -bottom-40 -right-40 w-80 h-80 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse" style="animation-delay: 2s;"></div>
        <div class="absolute top-40 left-1/2 w-80 h-80 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse" style="animation-delay: 4s;"></div>
    </div>

    <div class="relative w-full max-w-4xl">

        <!-- –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å -->
        <div id="donationBlock" class="glass rounded-2xl p-6 mb-8 text-center">
            <div class="flex items-center justify-center mb-4">
                <span class="text-2xl mr-2">üôè</span>
                <h2 class="text-xl font-semibold text-gray-800">–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</h2>
            </div>
            <p class="text-gray-600 mb-4">–ï—Å–ª–∏ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç, –º–æ–∂–µ—Ç–µ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∞</p>
            
            <div class="flex flex-wrap justify-center gap-3 mb-4">
                <a href="https://www.tbank.ru/cf/5JF3QJzjU42" target="_blank" 
                   class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                    <span class="mr-2">üè¶</span>
                    –¢-–ë–∞–Ω–∫
                </a>
                <a href="https://messenger.online.sberbank.ru/sl/iIHpU94AqyfHOTwgp" target="_blank" 
                   class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                    <span class="mr-2">üíö</span>
                    –°–±–µ—Ä–ë–∞–Ω–∫
                </a>
                <button onclick="copyCardNumber()" 
                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                    <span class="mr-2">üí≥</span>
                    –ö–∞—Ä—Ç–∞
                </button>
                <a href="https://t.me/BeeDrila" target="_blank" 
                   class="bg-blue-400 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                    <span class="mr-2">üì±</span>
                    Telegram
                </a>
            </div>
            
            <div class="text-sm text-gray-500 flex items-center justify-center gap-2">
                <p>–ö–∞—Ä—Ç–∞: <span id="cardNumber" class="font-mono">5536 9139 7125 8773</span></p>
                <button onclick="copyCardNumber()" 
                        class="text-gray-400 hover:text-gray-600 transition-colors" 
                        title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </button>
            </div>
        </div>


        <!-- Controls Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Connection -->
            <div class="glass rounded-2xl p-6 text-center">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
                <button id="connectBtn" class="w-16 h-16 rounded-full bg-gray-100 hover:bg-gray-200 transition-all duration-300 flex items-center justify-center mx-auto">
                    <svg class="bluetooth-icon disconnected" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/>
                    </svg>
                </button>
                <p class="text-gray-600 text-sm mt-3">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É Bluetooth –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</p>
            </div>

            <!-- Power Toggle -->
            <div class="glass rounded-2xl p-6 text-center">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">–ü–∏—Ç–∞–Ω–∏–µ</h3>
                <div class="flex items-center justify-center space-x-4">
                    <span class="text-sm text-gray-600">–í—ã–∫–ª</span>
                    <button id="powerToggle" class="ios-toggle" disabled></button>
                    <span class="text-sm text-gray-600">–í–∫–ª</span>
                </div>
            </div>

            <!-- Color -->
            <div class="glass rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">–¶–≤–µ—Ç</h3>
                <input type="color" id="colorPicker" class="color-picker mb-4" value="#ffffff" disabled>
                <div class="grid grid-cols-4 gap-2">
                    <div class="preset-color" style="background: #ff0000;" data-color="#ff0000"></div>
                    <div class="preset-color" style="background: #00ff00;" data-color="#00ff00"></div>
                    <div class="preset-color" style="background: #0000ff;" data-color="#0000ff"></div>
                    <div class="preset-color" style="background: #ffff00;" data-color="#ffff00"></div>
                    <div class="preset-color" style="background: #00ffff;" data-color="#00ffff"></div>
                    <div class="preset-color" style="background: #ff00ff;" data-color="#ff00ff"></div>
                    <div class="preset-color" style="background: #ffffff;" data-color="#ffffff"></div>
                    <div class="preset-color" style="background: #ffa500;" data-color="#ffa500"></div>
                </div>
            </div>

            <!-- Brightness -->
            <div class="glass rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">–Ø—Ä–∫–æ—Å—Ç—å</h3>
                <div class="space-y-3">
                    <input type="range" id="brightnessSlider" class="slider" min="0" max="100" value="100" disabled>
                    <div class="text-center">
                        <span id="brightnessValue" class="text-2xl font-bold text-gray-800">100</span>
                        <span class="text-gray-600 ml-1">%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Log -->
        <div class="hidden">
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        function copyCardNumber() {
            const cardNumber = '5536913971258773';
            navigator.clipboard.writeText(cardNumber).then(() => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∞—è —ç—Ç–æ –∫–Ω–æ–ø–∫–∞
                if (button.classList.contains('bg-purple-500')) {
                    // –ë–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ "–ö–∞—Ä—Ç–∞"
                    button.innerHTML = '<span class="mr-2">‚úÖ</span>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    button.classList.add('bg-green-500');
                    button.classList.remove('bg-purple-500');
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('bg-green-500');
                        button.classList.add('bg-purple-500');
                    }, 2000);
                } else {
                    // –ú–∞–ª–µ–Ω—å–∫–∞—è –∫–Ω–æ–ø–∫–∞ —Ä—è–¥–æ–º —Å –Ω–æ–º–µ—Ä–æ–º –∫–∞—Ä—Ç—ã
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                    
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                    }, 2000);
                }
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                alert('–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: ' + cardNumber);
            });
        }


        class MelkLampController {
            constructor() {
                this.device = null;
                this.server = null;
                this.characteristic = null;
                this.isConnected = false;
                this.currentColor = this.loadSavedColor(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç
                this.baseColor = { ...this.currentColor }; // –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —è—Ä–∫–æ—Å—Ç–∏
                this.currentBrightness = 100; // –¢–µ–∫—É—â–∞—è —è—Ä–∫–æ—Å—Ç—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
                this.lastBrightnessValue = 100; // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏
                this.brightnessTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞ —è—Ä–∫–æ—Å—Ç–∏
                this.colorTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞ —Ü–≤–µ—Ç–∞

                this.initElements();
                this.bindEvents();
                this.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞...', 'info');

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–æ–≤–æ–π –ø–∏–∫–µ—Ä –∏ —Å–ª–∞–π–¥–µ—Ä —è—Ä–∫–æ—Å—Ç–∏ —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                this.updateColorPicker();
                this.brightnessSlider.value = this.currentBrightness;
                this.brightnessValue.textContent = this.currentBrightness;

                // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                this.log(`–ó–∞–≥—Ä—É–∂–µ–Ω —Ü–≤–µ—Ç: RGB(${this.currentColor.r}, ${this.currentColor.g}, ${this.currentColor.b}), —è—Ä–∫–æ—Å—Ç—å: ${this.currentBrightness}%`, 'info');

                // –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É MELK —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    this.autoConnect();
                }, 1000);
            }

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–≤–µ—Ç–∞
            saveColor() {
                try {
                    const colorData = {
                        baseColor: this.baseColor,
                        currentColor: this.currentColor,
                        brightness: this.currentBrightness
                    };
                    localStorage.setItem('melkLampColor', JSON.stringify(colorData));
                    this.log(`–¶–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: RGB(${this.currentColor.r}, ${this.currentColor.g}, ${this.currentColor.b}), —è—Ä–∫–æ—Å—Ç—å: ${this.currentBrightness}%`, 'info');
                } catch (error) {
                    this.log('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞: ' + error.message, 'error');
                }
            }

            loadSavedColor() {
                try {
                    const saved = localStorage.getItem('melkLampColor');
                    if (saved) {
                        const colorData = JSON.parse(saved);
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –±–∞–∑–æ–≤—ã–º —Ü–≤–µ—Ç–æ–º –∏ —è—Ä–∫–æ—Å—Ç—å—é
                        if (colorData.baseColor && colorData.brightness !== undefined) {
                            this.baseColor = colorData.baseColor;
                            this.currentBrightness = colorData.brightness;
                            return colorData.currentColor;
                        } else {
                            // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç
                            this.baseColor = { ...colorData };
                            this.currentBrightness = 100;
                            return colorData;
                        }
                    }
                } catch (error) {
                    // –û—à–∏–±–∫–∞ –±—É–¥–µ—Ç –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                }
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–ª—ã–π —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                this.baseColor = { r: 255, g: 255, b: 255 };
                this.currentBrightness = 100;
                return { r: 255, g: 255, b: 255 };
            }

            resetSavedColor() {
                try {
                    localStorage.removeItem('melkLampColor');
                    this.currentColor = { r: 255, g: 255, b: 255 }; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –±–µ–ª—ã–π
                    this.baseColor = { r: 255, g: 255, b: 255 }; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç
                    this.currentBrightness = 100; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —è—Ä–∫–æ—Å—Ç—å
                    this.brightnessSlider.value = 100;
                    this.brightnessValue.textContent = 100;
                    this.updateColorPicker(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–æ–≤–æ–π –ø–∏–∫–µ—Ä
                    this.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç —Å–±—Ä–æ—à–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –±–µ–ª—ã–π —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.', 'info');
                } catch (error) {
                    this.log('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Ü–≤–µ—Ç–∞: ' + error.message, 'error');
                }
            }

            updateColorPicker() {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–æ–≤–æ–π –ø–∏–∫–µ—Ä —Å –±–∞–∑–æ–≤—ã–º —Ü–≤–µ—Ç–æ–º (–±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —è—Ä–∫–æ—Å—Ç–∏)
                const hexColor = `#${this.baseColor.r.toString(16).padStart(2, '0')}${this.baseColor.g.toString(16).padStart(2, '0')}${this.baseColor.b.toString(16).padStart(2, '0')}`;
                this.colorPicker.value = hexColor;
            }

            initElements() {
                this.connectBtn = document.getElementById('connectBtn');
                this.powerToggle = document.getElementById('powerToggle');
                this.colorPicker = document.getElementById('colorPicker');
                this.brightnessSlider = document.getElementById('brightnessSlider');
                this.brightnessValue = document.getElementById('brightnessValue');
                this.logEl = document.getElementById('log');
            }

            bindEvents() {
                this.connectBtn.addEventListener('click', () => this.toggleConnection());
                this.powerToggle.addEventListener('click', () => this.togglePower());

                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–º —Å –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–æ–º
                this.colorPicker.addEventListener('input', () => {
                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
                    if (this.colorTimeout) {
                        clearTimeout(this.colorTimeout);
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 200–º—Å
                    this.colorTimeout = setTimeout(() => {
                        this.setColor();
                    }, 200);
                });

                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç—å—é —Å –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–æ–º
                this.brightnessSlider.addEventListener('input', (e) => {
                    const newValue = parseInt(e.target.value);
                    this.brightnessValue.textContent = newValue;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ 5% –∏–ª–∏ –±–æ–ª—å—à–µ
                    const difference = Math.abs(newValue - this.lastBrightnessValue);
                    if (difference >= 5) {
                        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
                        if (this.brightnessTimeout) {
                            clearTimeout(this.brightnessTimeout);
                        }

                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 300–º—Å
                        this.brightnessTimeout = setTimeout(() => {
                            this.setBrightness();
                            this.lastBrightnessValue = newValue;
                        }, 300);
                    }
                });

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–∞
                this.brightnessSlider.addEventListener('change', (e) => {
                    const newValue = parseInt(e.target.value);
                    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –∏ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É
                    if (this.brightnessTimeout) {
                        clearTimeout(this.brightnessTimeout);
                        this.brightnessTimeout = null;
                    }
                    this.setBrightness();
                    this.lastBrightnessValue = newValue;
                });

                // Preset colors
                document.querySelectorAll('.preset-color').forEach(colorEl => {
                    colorEl.addEventListener('click', () => {
                        const color = colorEl.dataset.color;
                        this.colorPicker.value = color;
                        this.setColor(); // setColor() —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é —è—Ä–∫–æ—Å—Ç—å
                    });
                });
            }

            async autoConnect() {
                try {
                    this.log('–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É MELK...', 'info');

                    if (!navigator.bluetooth) {
                        throw new Error('Bluetooth –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    this.log('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ MELK –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–¥–∏–∞–ª–æ–≥ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã)...', 'info');

                    const device = await this.findMELKDevice(3000);

                    if (device) {
                        this.log(`–í—ã–±—Ä–∞–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device.name}`, 'info');
                        await this.connectToDevice(device);
                    } else {
                        this.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.', 'info');
                    }
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                }
            }

            async findMELKDevice(timeout = 3000) {
                return new Promise((resolve) => {
                    // Web Bluetooth API —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
                    // –ü–æ—ç—Ç–æ–º—É –º—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                    // —Å —Ç–∞–π–º–∞—É—Ç–æ–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è

                    const timer = setTimeout(() => {
                        resolve(null);
                    }, timeout);

                    try {
                        navigator.bluetooth.requestDevice({
                            filters: [{ namePrefix: 'MELK' }],
                            optionalServices: ['0000fff0-0000-1000-8000-00805f9b34fb']
                        }).then(device => {
                            clearTimeout(timer);
                            resolve(device);
                        }).catch(error => {
                            clearTimeout(timer);
                            resolve(null);
                        });
                    } catch (error) {
                        clearTimeout(timer);
                        resolve(null);
                    }
                });
            }

            async showDeviceSelectionDialog() {
                try {
                    this.log('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info');

                    this.device = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: 'MELK' }],
                        optionalServices: ['0000fff0-0000-1000-8000-00805f9b34fb']
                    });

                    await this.connectToDevice(this.device);
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${error.message}`, 'error');
                }
            }

            async connectToDevice(device) {
                try {
                    this.device = device;
                    this.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');

                    this.server = await this.device.gatt.connect();
                    this.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ GATT —Å–µ—Ä–≤–µ—Ä—É', 'success');

                    const service = await this.server.getPrimaryService('0000fff0-0000-1000-8000-00805f9b34fb');
                    this.characteristic = await service.getCharacteristic('0000fff3-0000-1000-8000-00805f9b34fb');

                    this.isConnected = true;
                    this.updateUI();
                    this.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –ª–∞–º–ø–µ!', 'success');

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
                    this.device.addEventListener('gattserverdisconnected', () => {
                        this.isConnected = false;
                        this.updateUI();
                        this.log('‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ', 'error');
                    });

                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É: ${error.message}`, 'error');
                }
            }

            async toggleConnection() {
                if (this.isConnected) {
                    await this.disconnect();
                } else {
                    await this.showDeviceSelectionDialog();
                }
            }

            async togglePower() {
                if (this.powerToggle.classList.contains('active')) {
                    await this.turnOff();
                } else {
                    await this.turnOn();
                }
            }

            async connect() {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                await this.showDeviceSelectionDialog();
            }

            async disconnect() {
                // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã
                if (this.brightnessTimeout) {
                    clearTimeout(this.brightnessTimeout);
                    this.brightnessTimeout = null;
                }
                if (this.colorTimeout) {
                    clearTimeout(this.colorTimeout);
                    this.colorTimeout = null;
                }

                if (this.device && this.device.gatt.connected) {
                    this.device.gatt.disconnect();
                }
                this.isConnected = false;
                this.updateUI();
                this.log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç –ª–∞–º–ø—ã', 'info');
            }

            async sendCommand(commandBytes, description) {
                if (!this.isConnected || !this.characteristic) {
                    this.log('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ª–∞–º–ø–µ', 'error');
                    return false;
                }

                try {
                    await this.characteristic.writeValue(commandBytes);
                    this.log(`${description} - ${commandBytes.reduce((str, byte) => str + byte.toString(16).padStart(2, '0'), '')}`, 'success');
                    return true;
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã: ${error.message}`, 'error');
                    return false;
                }
            }

            async turnOn() {
                // –í–∫–ª—é—á–∞–µ–º –ª–∞–º–ø—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ü–≤–µ—Ç–æ–º –∏ —è—Ä–∫–æ—Å—Ç—å—é
                const { r, g, b } = this.currentColor;
                const command = new Uint8Array([0x7E, 0x00, 0x05, 0x03, r, g, b, 0x00, 0xEF]);
                await this.sendCommand(command, `–í–∫–ª—é—á–∏—Ç—å –ª–∞–º–ø—É (RGB: ${r}, ${g}, ${b}, —è—Ä–∫–æ—Å—Ç—å: ${this.currentBrightness}%)`);
                this.powerToggle.classList.add('active');
            }

            async turnOff() {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ü–≤–µ—Ç –ø–µ—Ä–µ–¥ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ–º
                this.saveColor();

                const command = new Uint8Array([0x7E, 0x00, 0x05, 0x02, 0x00, 0x00, 0x00, 0x00, 0xEF]);
                await this.sendCommand(command, '–í—ã–∫–ª—é—á–∏—Ç—å –ª–∞–º–ø—É');
                this.powerToggle.classList.remove('active');
            }

            async setColor() {
                const color = this.colorPicker.value;
                const r = parseInt(color.substr(1, 2), 16);
                const g = parseInt(color.substr(3, 2), 16);
                const b = parseInt(color.substr(5, 2), 16);

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —è—Ä–∫–æ—Å—Ç—å
                this.baseColor = { r, g, b };

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —è—Ä–∫–æ—Å—Ç—å –∫ –Ω–æ–≤–æ–º—É –±–∞–∑–æ–≤–æ–º—É —Ü–≤–µ—Ç—É
                const brightnessMultiplier = this.currentBrightness / 100;
                const adjustedR = Math.round(r * brightnessMultiplier);
                const adjustedG = Math.round(g * brightnessMultiplier);
                const adjustedB = Math.round(b * brightnessMultiplier);

                this.currentColor = { r: adjustedR, g: adjustedG, b: adjustedB };
                this.saveColor(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥—É 0x03 —Å RGB –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, —É—á–∏—Ç—ã–≤–∞—é—â–∏–º–∏ —è—Ä–∫–æ—Å—Ç—å
                const command = new Uint8Array([0x7E, 0x00, 0x05, 0x03, adjustedR, adjustedG, adjustedB, 0x00, 0xEF]);
                await this.sendCommand(command, `–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç RGB(${adjustedR}, ${adjustedG}, ${adjustedB}) —Å —è—Ä–∫–æ—Å—Ç—å—é ${this.currentBrightness}%`);
            }

            async setBrightness() {
                const brightness = parseInt(this.brightnessSlider.value);
                const brightnessMultiplier = brightness / 100;

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —è—Ä–∫–æ—Å—Ç—å –∫ –±–∞–∑–æ–≤–æ–º—É —Ü–≤–µ—Ç—É (–Ω–µ –∫ —Ç–µ–∫—É—â–µ–º—É!)
                const r = Math.round(this.baseColor.r * brightnessMultiplier);
                const g = Math.round(this.baseColor.g * brightnessMultiplier);
                const b = Math.round(this.baseColor.b * brightnessMultiplier);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ü–≤–µ—Ç –∏ —è—Ä–∫–æ—Å—Ç—å
                this.currentColor = { r, g, b };
                this.currentBrightness = brightness;
                this.saveColor(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥—É 0x03 –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —è—Ä–∫–æ—Å—Ç—å—é (–∫–∞–∫ –≤ blue_brightness_test.py)
                // –§–æ—Ä–º–∞—Ç: 7E 00 05 03 [R] [G] [B] 00 EF
                const command = new Uint8Array([0x7E, 0x00, 0x05, 0x03, r, g, b, 0x00, 0xEF]);
                await this.sendCommand(command, `–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —è—Ä–∫–æ—Å—Ç—å ${brightness}% (RGB: ${r}, ${g}, ${b})`);
            }


            updateUI() {
                const elements = [
                    this.powerToggle, this.colorPicker, this.brightnessSlider
                ];

                elements.forEach(el => {
                    el.disabled = !this.isConnected;
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º Bluetooth –∏–∫–æ–Ω–∫—É
                const bluetoothIcon = this.connectBtn.querySelector('.bluetooth-icon');
                if (this.isConnected) {
                    bluetoothIcon.classList.remove('disconnected');
                    bluetoothIcon.classList.add('connected');
                } else {
                    bluetoothIcon.classList.remove('connected');
                    bluetoothIcon.classList.add('disconnected');
                }
            }

            log(message, type = 'info') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –ª–æ–≥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
                if (!this.logEl) {
                    console.log(`[${type.toUpperCase()}] ${message}`);
                    return;
                }

                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;

                this.logEl.appendChild(logEntry);
                this.logEl.scrollTop = this.logEl.scrollHeight;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        const controller = new MelkLampController();
    </script>
</body>
</html>
